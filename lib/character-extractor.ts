/**
 * Character Extractor Module
 * 
 * Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ĞµĞ¹ Ğ¸Ğ· Ğ·Ğ°ÑÑ‚Ğ°Ğ²ĞºĞ¸ Ğ²Ğ¸Ğ´ĞµĞ¾ Ñ‡ĞµÑ€ĞµĞ· Gemini.
 * ĞĞ• Ñ…Ğ°Ñ€Ğ´ĞºĞ¾Ğ´Ğ¸Ñ‚ Ğ¸Ğ¼ĞµĞ½Ğ° - ĞºĞ°Ğ¶Ğ´Ğ¾Ğµ Ğ²Ğ¸Ğ´ĞµĞ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ¸Ğ½Ğ´Ğ¸Ğ²Ğ¸Ğ´ÑƒĞ°Ğ»ÑŒĞ½Ğ¾.
 */

export interface ExtractedCharacter {
  name: string;              // Ğ˜Ğ¼Ñ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ° (Ğ¨Ğ£Ğ ĞĞ§ĞšĞ, Ğ®Ğ¡Ğ•Ğ¤)
  actor?: string;            // Ğ˜Ğ¼Ñ Ğ°ĞºÑ‚Ñ‘Ñ€Ğ° (Ğ¢Ğ°Ñ‚ÑŒÑĞ½Ğ° Ğ Ñ‹Ğ±Ğ¸Ğ½ĞµÑ†)
  description?: string;      // Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ (Ñ€Ñ‹Ğ¶ĞµĞ²Ğ¾Ğ»Ğ¾ÑĞ°Ñ Ğ´ĞµĞ²ÑƒÑˆĞºĞ°)
  role?: string;             // Ğ Ğ¾Ğ»ÑŒ (Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ½Ğ¸Ñ†Ğ° ÑĞ°Ğ»Ğ¾Ğ½Ğ°, Ğ¼ÑƒĞ¶ Ğ³ĞµÑ€Ğ¾Ğ¸Ğ½Ğ¸)
  gender?: 'male' | 'female' | 'unknown';
}

export interface CharacterMemory {
  characters: ExtractedCharacter[];
  extractedFromTimecode: string;
  videoTitle?: string;
  extractionTimestamp: string;
}

/**
 * Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ĞµĞ¹ Ğ¸Ğ· Ğ·Ğ°ÑÑ‚Ğ°Ğ²ĞºĞ¸
 */
export function createCharacterExtractionPrompt(): string {
  return `Ğ¢Ñ‹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑˆÑŒ Ğ—ĞĞ¡Ğ¢ĞĞ’ĞšĞ£ Ñ„Ğ¸Ğ»ÑŒĞ¼Ğ°/ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ°. Ğ¢Ğ²Ğ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ Ğ’Ğ¡Ğ•Ğ¥ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ĞµĞ¹.

Ğ’ĞĞ–ĞĞ: Ğ’Ğ½Ğ¸Ğ¼Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ½Ğ° Ñ‚Ğ¸Ñ‚Ñ€Ñ‹ Ğ² Ğ·Ğ°ÑÑ‚Ğ°Ğ²ĞºĞµ. ĞĞ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ¾Ğ½Ğ¸ Ğ²Ñ‹Ğ³Ğ»ÑĞ´ÑÑ‚ Ñ‚Ğ°Ğº:
- "Ğ˜Ğ¼Ñ ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ° - Ğ˜Ğ¼Ñ ĞĞºÑ‚Ñ‘Ñ€Ğ°"
- "Ğ˜Ğ¼Ñ ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ°. Ğ˜Ğ¼Ñ ĞĞºÑ‚Ñ‘Ñ€Ğ°"
- Ğ¢Ğ¸Ñ‚Ñ€ Ñ Ğ¸Ğ¼ĞµĞ½ĞµĞ¼ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ° Ğ¿Ğ¾ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ñ€ÑĞ´Ğ¾Ğ¼ Ñ ĞµĞ³Ğ¾ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸ĞµĞ¼

Ğ˜ĞĞ¡Ğ¢Ğ Ğ£ĞšĞ¦Ğ˜Ğ˜:
1. ĞĞ°Ğ¹Ğ´Ğ¸ Ğ’Ğ¡Ğ• Ñ‚Ğ¸Ñ‚Ñ€Ñ‹ Ñ Ğ¸Ğ¼ĞµĞ½Ğ°Ğ¼Ğ¸ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ĞµĞ¹ Ğ¸ Ğ°ĞºÑ‚Ñ‘Ñ€Ğ¾Ğ²
2. ĞĞ¿Ğ¸ÑˆĞ¸ Ğ²Ğ½ĞµÑˆĞ½Ğ¾ÑÑ‚ÑŒ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ° (Ñ†Ğ²ĞµÑ‚ Ğ²Ğ¾Ğ»Ğ¾Ñ, Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸)
3. ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸ Ñ€Ğ¾Ğ»ÑŒ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ° ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½Ğ¾ Ğ¸Ğ· ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
4. Ğ£ĞºĞ°Ğ¶Ğ¸ Ğ¿Ğ¾Ğ» Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ°

Ğ¤ĞĞ ĞœĞĞ¢ ĞĞ¢Ğ’Ğ•Ğ¢Ğ (ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ JSON):
{
  "videoTitle": "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ¸Ğ»ÑŒĞ¼Ğ°/ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ° ĞµÑĞ»Ğ¸ Ğ²Ğ¸Ğ´Ğ½Ğ¾",
  "characters": [
    {
      "name": "Ğ˜ĞœĞ¯ ĞŸĞ•Ğ Ğ¡ĞĞĞĞ–Ğ",
      "actor": "Ğ˜Ğ¼Ñ ĞĞºÑ‚Ñ‘Ñ€Ğ°",
      "description": "ĞºÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ²Ğ½ĞµÑˆĞ½Ğ¾ÑÑ‚Ğ¸",
      "role": "Ñ€Ğ¾Ğ»ÑŒ Ğ² ÑÑĞ¶ĞµÑ‚Ğµ ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½Ğ¾",
      "gender": "male" Ğ¸Ğ»Ğ¸ "female"
    }
  ]
}

ĞŸĞ Ğ˜ĞœĞ•Ğ  Ğ´Ğ»Ñ ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ° Ğ¿Ñ€Ğ¾ ÑĞ°Ğ»Ğ¾Ğ½ ĞºÑ€Ğ°ÑĞ¾Ñ‚Ñ‹:
{
  "videoTitle": "Ğ›ÑĞ±Ğ¾Ğ²ÑŒ Ğ¸ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ğµ Ğ³Ğ»ÑƒĞ¿Ğ¾ÑÑ‚Ğ¸",
  "characters": [
    {
      "name": "Ğ¨Ğ£Ğ ĞĞ§ĞšĞ",
      "actor": "Ğ¢Ğ°Ñ‚ÑŒÑĞ½Ğ° Ğ Ñ‹Ğ±Ğ¸Ğ½ĞµÑ†",
      "description": "Ñ€Ñ‹Ğ¶ĞµĞ²Ğ¾Ğ»Ğ¾ÑĞ°Ñ Ğ´ĞµĞ²ÑƒÑˆĞºĞ°, Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ² ÑĞ°Ğ»Ğ¾Ğ½Ğµ",
      "role": "Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ½Ğ¸Ñ†Ğ° ÑĞ°Ğ»Ğ¾Ğ½Ğ° ĞºÑ€Ğ°ÑĞ¾Ñ‚Ñ‹",
      "gender": "female"
    },
    {
      "name": "Ğ‘Ğ­Ğ›Ğ›Ğ",
      "actor": "ĞŸĞ¾Ğ»Ğ¸Ğ½Ğ° Ğ“Ğ°Ğ½ÑˆĞ¸Ğ½Ğ°",
      "description": "ÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ´ĞµĞ²ÑƒÑˆĞºĞ°, Ñ‡Ğ°ÑÑ‚Ğ¾ Ñ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»ÑĞ¼Ğ¸",
      "role": "Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ½Ğ¸Ñ†Ğ° ÑĞ°Ğ»Ğ¾Ğ½Ğ°, Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ÑÑ ÑĞ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ¼",
      "gender": "female"
    }
  ]
}

Ğ’ĞĞ–ĞĞ:
- Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°Ğ¹ Ğ¢ĞĞ›Ğ¬ĞšĞ Ñ‚Ğµ Ğ¸Ğ¼ĞµĞ½Ğ°, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ÑĞ²Ğ½Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ñ‹ Ğ² Ñ‚Ğ¸Ñ‚Ñ€Ğ°Ñ…
- Ğ•ÑĞ»Ğ¸ Ğ¸Ğ¼Ñ Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¾ â€” ĞĞ• Ğ¿Ñ€Ğ¸Ğ´ÑƒĞ¼Ñ‹Ğ²Ğ°Ğ¹ ĞµĞ³Ğ¾
- ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ğ¢ĞĞ›Ğ¬ĞšĞ JSON, Ğ±ĞµĞ· ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸ĞµĞ²`;
}

/**
 * ĞŸĞ°Ñ€ÑĞ¸Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ Gemini Ñ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ°Ğ¼Ğ¸
 */
export function parseCharacterExtractionResponse(response: string): CharacterMemory | null {
  try {
    // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ markdown
    let cleaned = response
      .replace(/```json\s*/g, '')
      .replace(/```\s*/g, '')
      .trim();
    
    // Ğ˜Ñ‰ĞµĞ¼ JSON Ğ² Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ
    const jsonMatch = cleaned.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      console.error('No JSON found in character extraction response');
      return null;
    }
    
    const parsed = JSON.parse(jsonMatch[0]);
    
    if (!parsed.characters || !Array.isArray(parsed.characters)) {
      console.error('Invalid characters array in response');
      return null;
    }
    
    // ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµĞ¼ Ğ¸Ğ¼ĞµĞ½Ğ° Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ĞµĞ¹
    const characters: ExtractedCharacter[] = parsed.characters.map((c: any) => ({
      name: String(c.name || '').toUpperCase().trim(),
      actor: c.actor ? String(c.actor).trim() : undefined,
      description: c.description ? String(c.description).trim() : undefined,
      role: c.role ? String(c.role).trim() : undefined,
      gender: c.gender === 'male' ? 'male' : c.gender === 'female' ? 'female' : 'unknown',
    })).filter((c: ExtractedCharacter) => c.name.length > 0);
    
    return {
      characters,
      extractedFromTimecode: '00:00:00:00',
      videoTitle: parsed.videoTitle,
      extractionTimestamp: new Date().toISOString(),
    };
  } catch (error) {
    console.error('Error parsing character extraction response:', error);
    return null;
  }
}

/**
 * Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ñ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¼Ğ¸ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ°Ğ¼Ğ¸ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ°
 */
export function formatCharactersForPrompt(memory: CharacterMemory): string {
  if (!memory.characters || memory.characters.length === 0) {
    return '';
  }
  
  const lines = ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'];
  lines.push('ğŸ“‹ Ğ˜Ğ—Ğ’Ğ•Ğ¡Ğ¢ĞĞ«Ğ• ĞŸĞ•Ğ Ğ¡ĞĞĞĞ–Ğ˜ Ğ­Ğ¢ĞĞ“Ğ Ğ’Ğ˜Ğ”Ğ•Ğ:');
  lines.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  for (const char of memory.characters) {
    let line = `â€¢ ${char.name}`;
    if (char.actor) {
      line += ` (Ğ°ĞºÑ‚Ñ‘Ñ€: ${char.actor})`;
    }
    if (char.description) {
      line += ` â€” ${char.description}`;
    }
    lines.push(line);
  }
  
  lines.push('');
  lines.push('âš ï¸ Ğ’ĞĞ–ĞĞ: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ˜ĞœĞ•ĞĞĞ ÑÑ‚Ğ¸ Ğ¸Ğ¼ĞµĞ½Ğ° Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°Ñ…!');
  lines.push('   ĞĞ• Ğ¿Ğ¸ÑˆĞ¸ "ĞœĞ£Ğ–Ğ§Ğ˜ĞĞ", "Ğ–Ğ•ĞĞ©Ğ˜ĞĞ", "Ğ”Ğ•Ğ’Ğ£Ğ¨ĞšĞ" ĞµÑĞ»Ğ¸ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ Ğ¸Ğ·Ğ²ĞµÑÑ‚ĞµĞ½.');
  lines.push('   ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Ğ•ÑĞ»Ğ¸ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ Ğ‘ÑĞ»Ğ»Ğ°, Ğ¿Ğ¸ÑˆĞ¸ "Ğ‘Ğ­Ğ›Ğ›Ğ:", Ğ° Ğ½Ğµ "Ğ–Ğ•ĞĞ©Ğ˜ĞĞ:"');
  lines.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  return lines.join('\n');
}

/**
 * Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ ĞºĞ°Ñ€Ñ‚Ñƒ Ğ·Ğ°Ğ¼ĞµĞ½Ñ‹ generic Ğ¸Ğ¼Ñ‘Ğ½ Ğ½Ğ° Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ
 */
export function createReplacementMap(memory: CharacterMemory): Map<string, string[]> {
  const map = new Map<string, string[]>();
  
  // Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ĞµĞ¹ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ»Ñƒ
  const females = memory.characters.filter(c => c.gender === 'female').map(c => c.name);
  const males = memory.characters.filter(c => c.gender === 'male').map(c => c.name);
  
  // Generic placeholders â†’ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ¼ĞµĞ½
  if (females.length > 0) {
    map.set('Ğ–Ğ•ĞĞ©Ğ˜ĞĞ', females);
    map.set('Ğ”Ğ•Ğ’Ğ£Ğ¨ĞšĞ', females);
    map.set('Ğ”Ğ•Ğ’ĞĞ§ĞšĞ', females);
  }
  
  if (males.length > 0) {
    map.set('ĞœĞ£Ğ–Ğ§Ğ˜ĞĞ', males);
    map.set('ĞŸĞĞ Ğ•ĞĞ¬', males);
    map.set('ĞœĞ£Ğ–', males);
    map.set('ĞœĞ£Ğ–Ğ˜Ğš', males);
  }
  
  return map;
}

/**
 * ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ Ğ²ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ° Ğ¿Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ñƒ
 */
export function findCharacterByContext(
  memory: CharacterMemory,
  context: string,
  genericName: string
): string | null {
  if (!memory.characters || memory.characters.length === 0) {
    return null;
  }
  
  const contextLower = context.toLowerCase();
  const isFemale = ['Ğ–Ğ•ĞĞ©Ğ˜ĞĞ', 'Ğ”Ğ•Ğ’Ğ£Ğ¨ĞšĞ', 'Ğ”Ğ•Ğ’ĞĞ§ĞšĞ'].includes(genericName.toUpperCase());
  const isMale = ['ĞœĞ£Ğ–Ğ§Ğ˜ĞĞ', 'ĞŸĞĞ Ğ•ĞĞ¬', 'ĞœĞ£Ğ–', 'ĞœĞ£Ğ–Ğ˜Ğš'].includes(genericName.toUpperCase());
  
  // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ»Ñƒ
  const candidates = memory.characters.filter(c => {
    if (isFemale && c.gender !== 'female') return false;
    if (isMale && c.gender !== 'male') return false;
    return true;
  });
  
  if (candidates.length === 0) {
    return null;
  }
  
  // Ğ˜Ñ‰ĞµĞ¼ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğµ
  for (const char of candidates) {
    const description = char.description?.toLowerCase() || '';
    const role = char.role?.toLowerCase() || '';
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ° Ğ¸Ğ· Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ
    const keywords = [...description.split(/\s+/), ...role.split(/\s+/)]
      .filter(w => w.length > 3);
    
    for (const keyword of keywords) {
      if (contextLower.includes(keyword)) {
        return char.name;
      }
    }
  }
  
  // Ğ•ÑĞ»Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ½Ğµ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ»Ñƒ
  // (Ğ´Ğ»Ñ Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ñ… Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ĞµĞ¹ ÑÑ‚Ğ¾ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚)
  return candidates[0]?.name || null;
}

/**
 * Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ĞµĞ¹ Ğ¸Ğ· Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ğ½ĞºĞ°
 * 
 * Ğ˜Ğ¡Ğ¢ĞĞ§ĞĞ˜ĞšĞ˜ (Ğ² Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞµ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ°):
 * 1. Ğ¢Ğ¸Ñ‚Ñ€Ñ‹: "Ğ¨ÑƒÑ€Ğ¾Ñ‡ĞºĞ° - Ğ¢Ğ°Ñ‚ÑŒÑĞ½Ğ° Ğ Ñ‹Ğ±Ğ¸Ğ½ĞµÑ†"
 * 2. Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¸: ÑĞ¿Ğ¸ĞºĞµÑ€ Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ (Ğ“ĞĞ›Ğ¯, Ğ¢ĞĞœĞ)
 * 3. ĞĞ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°Ñ…: "Ğ“Ğ°Ğ»Ñ, Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚!"
 * 4. Ğ£Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ñ Ğ² Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸ÑÑ…: "Ğ‘ÑĞ»Ğ»Ğ° Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğº Ğ¨ÑƒÑ€Ğ¾Ñ‡ĞºĞµ"
 */
export function extractCharactersFromOpeningCredits(
  entries: Array<{ description?: string; dialogues?: string }>
): CharacterMemory {
  const characters: ExtractedCharacter[] = [];
  const seenNames = new Set<string>();
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ğ¡Ğ¿Ğ¸ÑĞºĞ¸ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»Ğ° Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // Ğ–ĞµĞ½ÑĞºĞ¸Ğµ Ğ¸Ğ¼ĞµĞ½Ğ° Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»Ğ°
  const femaleNames = new Set([
    'Ğ¨Ğ£Ğ ĞĞ§ĞšĞ', 'Ğ‘Ğ­Ğ›Ğ›Ğ', 'Ğ‘Ğ•Ğ›Ğ›Ğ', 'Ğ¢ĞĞœĞ', 'Ğ¡Ğ’Ğ•Ğ¢Ğ˜Ğš', 'Ğ’ĞĞ Ğ’ĞĞ Ğ', 'Ğ¡Ğ®Ğ—ĞĞĞĞ', 
    'ĞĞĞ”Ğ•Ğ–Ğ”Ğ', 'Ğ›Ğ®Ğ”ĞĞ¡Ğ¯', 'Ğ“ĞĞ›Ğ¯', 'Ğ“ĞĞ›Ğ˜ĞĞ', 'Ğ›ĞĞ Ğ˜Ğ¡Ğ', 'Ğ¡Ğ’Ğ•Ğ¢Ğ', 'Ğ’ĞĞ›Ğ¯',
    'Ğ›Ğ•ĞĞ', 'Ğ—Ğ˜ĞĞ', 'Ğ¢ĞĞĞ¯', 'Ğ¢ĞĞ¢Ğ¬Ğ¯ĞĞ', 'ĞĞĞĞ', 'ĞœĞĞ Ğ˜Ğ¯', 'ĞœĞĞ Ğ˜ĞĞ',
    'ĞĞĞ¢ĞĞ¨Ğ', 'ĞšĞĞ¢Ğ¯', 'ĞĞĞ¡Ğ¢Ğ¯', 'ĞĞ›Ğ¯', 'Ğ›Ğ®Ğ”Ğ', 'ĞœĞĞ¨Ğ', 'Ğ›Ğ®Ğ‘Ğ',
    'ĞšĞ›Ğ˜Ğ•ĞĞ¢ĞšĞ', 'Ğ¡ĞĞ¡Ğ•Ğ”ĞšĞ', 'ĞŸĞĞ”Ğ Ğ£Ğ“Ğ', 'Ğ–Ğ•ĞĞ', 'Ğ”ĞĞ§Ğ¬', 'ĞœĞĞœĞ', 'Ğ‘ĞĞ‘Ğ£Ğ¨ĞšĞ'
  ]);
  
  const maleNames = new Set([
    'Ğ®Ğ¡Ğ•Ğ¤', 'ĞœĞĞ¥ĞĞœĞœĞ•Ğ”', 'Ğ˜ĞĞ¡Ğ˜Ğ¤', 'Ğ¡ĞĞ¨Ğ', 'Ğ”Ğ˜ĞœĞ', 'Ğ’ĞĞ’Ğ', 'Ğ–Ğ•ĞĞ¯', 
    'ĞšĞĞ›Ğ¯', 'ĞœĞ˜Ğ¨Ğ', 'ĞĞ›Ğ•Ğ“', 'Ğ˜Ğ“ĞĞ Ğ¬', 'Ğ¡Ğ•Ğ Ğ“Ğ•Ğ™', 'ĞĞĞ”Ğ Ğ•Ğ™', 'ĞŸĞĞ’Ğ•Ğ›',
    'Ğ’Ğ˜Ğ¢ĞĞ›Ğ˜Ğš', 'Ğ’ĞĞ’Ğ§Ğ˜Ğš', 'Ğ¢ĞĞ›Ğ˜Ğš', 'ĞŸĞ•Ğ¢Ğ¯', 'Ğ’Ğ˜Ğ¢Ğ¯', 'ĞšĞĞ¡Ğ¢Ğ¯',
    'ĞšĞ›Ğ˜Ğ•ĞĞ¢', 'Ğ¡ĞĞ¡Ğ•Ğ”', 'Ğ”Ğ Ğ£Ğ“', 'ĞœĞ£Ğ–', 'Ğ¡Ğ«Ğ', 'ĞŸĞĞŸĞ', 'Ğ”Ğ•Ğ”Ğ£Ğ¨ĞšĞ'
  ]);
  
  // Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ÑĞ»Ğ¾Ğ²Ğ°, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ĞĞ• ÑĞ²Ğ»ÑÑÑ‚ÑÑ Ğ¸Ğ¼ĞµĞ½Ğ°Ğ¼Ğ¸ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ĞµĞ¹
  const excludeWords = new Set([
    'Ğ Ğ•Ğ–Ğ˜Ğ¡Ğ¡Ğ•Ğ ', 'Ğ Ğ•Ğ–Ğ˜Ğ¡Ğ¡ĞĞ ', 'ĞŸĞ ĞĞ”Ğ®Ğ¡Ğ•Ğ ', 'ĞĞŸĞ•Ğ ĞĞ¢ĞĞ ', 'Ğ¡Ğ¦Ğ•ĞĞĞ Ğ˜Ğ™', 'ĞĞ’Ğ¢ĞĞ ',
    'ĞœĞ£Ğ—Ğ«ĞšĞ', 'ĞœĞĞĞ¢ĞĞ–', 'Ğ¥Ğ£Ğ”ĞĞ–ĞĞ˜Ğš', 'Ğ—Ğ’Ğ£Ğš', 'Ğ”Ğ˜Ğ Ğ•ĞšĞ¢ĞĞ ', 'ĞšĞ Ğ•ĞĞ¢Ğ˜Ğ’ĞĞ«Ğ™',
    'Ğ¢Ğ•Ğ›Ğ•ĞšĞĞœĞŸĞĞĞ˜Ğ¯', 'ĞŸĞĞ Ğ¢ĞĞ•Ğ ', 'ĞŸĞĞ Ğ¢ĞĞĞ ', 'Ğ¤Ğ˜Ğ›Ğ¬Ğœ', 'Ğ¡Ğ•Ğ Ğ˜ĞĞ›', 'ĞŸĞĞ¡Ğ¢ĞĞĞĞ’Ğ©Ğ˜Ğš',
    'Ğ˜Ğ¡ĞŸĞĞ›ĞĞ˜Ğ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ™', 'Ğ“Ğ›ĞĞ’ĞĞ«Ğ™', 'Ğ’Ğ•Ğ”Ğ£Ğ©Ğ˜Ğ™', 'ĞŸĞ Ğ•Ğ”Ğ¡Ğ¢ĞĞ’Ğ›Ğ¯Ğ•Ğ¢', 'Ğ¢Ğ˜Ğ¢Ğ ',
    'ĞœĞ£Ğ–Ğ§Ğ˜ĞĞ', 'Ğ–Ğ•ĞĞ©Ğ˜ĞĞ', 'Ğ”Ğ•Ğ’Ğ£Ğ¨ĞšĞ', 'ĞŸĞĞ Ğ•ĞĞ¬', 'Ğ§Ğ•Ğ›ĞĞ’Ğ•Ğš', 'Ğ“ĞĞ›ĞĞ¡'
  ]);
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ°
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  function addCharacter(name: string, actor?: string, source?: string) {
    const charName = name.trim().toUpperCase();
    
    // ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞµÑĞ»Ğ¸ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ, ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğµ Ğ¸Ğ¼Ñ, Ğ¸Ğ»Ğ¸ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¾
    if (seenNames.has(charName)) return;
    if (charName.length < 3) return;
    if (excludeWords.has(charName)) return;
    
    // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ»
    let gender: 'male' | 'female' | 'unknown' = 'unknown';
    if (femaleNames.has(charName)) gender = 'female';
    else if (maleNames.has(charName)) gender = 'male';
    // Ğ­Ğ²Ñ€Ğ¸ÑÑ‚Ğ¸ĞºĞ°: Ğ¸Ğ¼ĞµĞ½Ğ° Ğ½Ğ° -Ğ, -Ğ¯ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ¶ĞµĞ½ÑĞºĞ¸Ğµ
    else if (charName.endsWith('Ğ') || charName.endsWith('Ğ¯')) gender = 'female';
    
    characters.push({
      name: charName,
      actor: actor,
      gender,
      description: source,
    });
    
    seenNames.add(charName);
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ğ˜Ğ¡Ğ¢ĞĞ§ĞĞ˜Ğš 1: Ğ¢Ğ¸Ñ‚Ñ€Ñ‹
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const titlePatterns = [
    // "Ğ¢Ğ¸Ñ‚Ñ€ Â«Ğ¨ÑƒÑ€Ğ¾Ñ‡ĞºĞ° - Ğ¢Ğ°Ñ‚ÑŒÑĞ½Ğ° Ğ Ñ‹Ğ±Ğ¸Ğ½ĞµÑ†Â»"
    /(?:Ñ‚Ğ¸Ñ‚Ñ€|Ğ¢Ğ¸Ñ‚Ñ€|Ğ¢Ğ˜Ğ¢Ğ )[:\s]*[Â«"]?([Ğ-Ğ¯ĞĞ°-ÑÑ‘]+)[Â»"]?\s*[-â€“â€”.]\s*([Ğ-Ğ¯Ğ][Ğ°-ÑÑ‘]+\s+[Ğ-Ğ¯Ğ][Ğ°-ÑÑ‘]+)/gi,
    // "Â«Ğ¨ÑƒÑ€Ğ¾Ñ‡ĞºĞ°. Ğ¢Ğ°Ñ‚ÑŒÑĞ½Ğ° Ğ Ñ‹Ğ±Ğ¸Ğ½ĞµÑ†Â»"
    /[Â«"]([Ğ-Ğ¯ĞĞ°-ÑÑ‘]+)\.\s*([Ğ-Ğ¯Ğ][Ğ°-ÑÑ‘]+\s+[Ğ-Ğ¯Ğ][Ğ°-ÑÑ‘]+)[Â»"]/gi,
    // "Ğ¨ÑƒÑ€Ğ¾Ñ‡ĞºĞ° - Ğ¢Ğ°Ñ‚ÑŒÑĞ½Ğ° Ğ Ñ‹Ğ±Ğ¸Ğ½ĞµÑ†" (Ğ±ĞµĞ· Ñ‚Ğ¸Ñ‚Ñ€Ğ°)
    /([Ğ-Ğ¯Ğ][Ğ°-ÑÑ‘]+)\s*[-â€“â€”]\s*([Ğ-Ğ¯Ğ][Ğ°-ÑÑ‘]+\s+[Ğ-Ğ¯Ğ][Ğ°-ÑÑ‘]+)/g,
  ];
  
  for (const entry of entries) {
    const text = `${entry.description || ''}`;
    
    for (const pattern of titlePatterns) {
      pattern.lastIndex = 0;
      let match;
      while ((match = pattern.exec(text)) !== null) {
        addCharacter(match[1], match[2], 'Ñ‚Ğ¸Ñ‚Ñ€Ñ‹');
      }
    }
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ğ˜Ğ¡Ğ¢ĞĞ§ĞĞ˜Ğš 2: Ğ¡Ğ¿Ğ¸ĞºĞµÑ€Ñ‹ Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°Ñ…
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¸ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ÑÑ‚ÑÑ Ñ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ°:
  // "Ğ“ĞĞ›Ğ¯\nĞŸÑ€Ğ¸Ğ²ĞµÑ‚!" Ğ¸Ğ»Ğ¸ "Ğ“ĞĞ›Ğ¯ Ğ—Ğš\nĞŸÑ€Ğ¸Ğ²ĞµÑ‚!"
  const speakerPattern = /^([Ğ-Ğ¯Ğ]+(?:\s+Ğ—Ğš)?)\s*$/gm;
  
  for (const entry of entries) {
    const dialogues = entry.dialogues || '';
    
    speakerPattern.lastIndex = 0;
    let match;
    while ((match = speakerPattern.exec(dialogues)) !== null) {
      // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ—Ğš/Ğ“Ğ— ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
      const name = match[1].replace(/\s*(Ğ—Ğš|Ğ“Ğ—)$/, '').trim();
      addCharacter(name, undefined, 'Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³');
    }
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ğ˜Ğ¡Ğ¢ĞĞ§ĞĞ˜Ğš 3: ĞĞ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°Ñ…
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // "Ğ“Ğ°Ğ»Ñ, Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚!" Ğ¸Ğ»Ğ¸ "Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚, Ğ“Ğ°Ğ»Ñ!"
  const addressPatterns = [
    /([Ğ-Ğ¯Ğ][Ğ°-ÑÑ‘]+),\s*(?:Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚|Ğ·Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹|ÑĞ»ÑƒÑˆĞ°Ğ¹|Ğ¿Ğ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸|Ğ¸Ğ´Ğ¸|ÑĞºĞ°Ğ¶Ğ¸)/gi,
    /(?:Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚|Ğ·Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹|ÑĞ»ÑƒÑˆĞ°Ğ¹|Ğ¿Ğ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸|Ğ¸Ğ´Ğ¸|ÑĞºĞ°Ğ¶Ğ¸)[,!]?\s*([Ğ-Ğ¯Ğ][Ğ°-ÑÑ‘]+)/gi,
  ];
  
  for (const entry of entries) {
    const dialogues = entry.dialogues || '';
    
    for (const pattern of addressPatterns) {
      pattern.lastIndex = 0;
      let match;
      while ((match = pattern.exec(dialogues)) !== null) {
        addCharacter(match[1], undefined, 'Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ');
      }
    }
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ğ˜Ğ¡Ğ¢ĞĞ§ĞĞ˜Ğš 4: Ğ£Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ñ Ğ² Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸ÑÑ…
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // "Ğ“Ğ°Ğ»Ñ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚", "Ğ‘ÑĞ»Ğ»Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ¸Ñ‚", "Ğº Ğ¨ÑƒÑ€Ğ¾Ñ‡ĞºĞµ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ¸Ñ‚"
  const descriptionPatterns = [
    // Ğ˜Ğ¼Ñ + Ğ³Ğ»Ğ°Ğ³Ğ¾Ğ»: "Ğ“Ğ°Ğ»Ñ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚"
    /([Ğ-Ğ¯Ğ][Ğ°-ÑÑ‘]+)\s+(?:Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚|Ğ²Ñ…Ğ¾Ğ´Ğ¸Ñ‚|Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ¸Ñ‚|ÑĞ¸Ğ´Ğ¸Ñ‚|ÑÑ‚Ğ¾Ğ¸Ñ‚|Ğ¸Ğ´Ñ‘Ñ‚|Ğ¸Ğ´ĞµÑ‚|ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸Ñ‚|Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚|ÑĞ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚|ÑƒĞ»Ñ‹Ğ±Ğ°ĞµÑ‚ÑÑ|ÑĞ¼ĞµÑ‘Ñ‚ÑÑ|ÑĞ¼ĞµĞµÑ‚ÑÑ|Ğ¿Ğ»Ğ°Ñ‡ĞµÑ‚|ĞºÑ€Ğ¸Ñ‡Ğ¸Ñ‚|ÑˆĞµĞ¿Ñ‡ĞµÑ‚|ÑĞ»ÑƒÑˆĞ°ĞµÑ‚|Ğ´ĞµĞ»Ğ°ĞµÑ‚|Ğ±ĞµÑ€Ñ‘Ñ‚|Ğ±ĞµÑ€ĞµÑ‚|ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚|ĞºĞ»Ğ°Ğ´Ñ‘Ñ‚|ĞºĞ»Ğ°Ğ´ĞµÑ‚|Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚|Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚|Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ¸Ñ‚|Ğ¾Ñ‚Ñ…Ğ¾Ğ´Ğ¸Ñ‚|Ğ¿Ğ¾Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ|Ğ¾Ğ±Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ)/gi,
    // Ğº + Ğ˜Ğ¼Ñ: "Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğº Ğ¨ÑƒÑ€Ğ¾Ñ‡ĞºĞµ"
    /(?:Ğº|Ñƒ|Ñ|Ğ¾Ñ‚)\s+([Ğ-Ğ¯Ğ][Ğ°-ÑÑ‘]+[ĞµĞ¸Ñ‹Ñƒ]?)/gi,
  ];
  
  for (const entry of entries) {
    const description = entry.description || '';
    
    for (const pattern of descriptionPatterns) {
      pattern.lastIndex = 0;
      let match;
      while ((match = pattern.exec(description)) !== null) {
        // ĞŸÑ€Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğº Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¼Ñƒ Ğ¿Ğ°Ğ´ĞµĞ¶Ñƒ (Ğ¿Ñ€Ğ¾ÑÑ‚Ğ°Ñ ÑĞ²Ñ€Ğ¸ÑÑ‚Ğ¸ĞºĞ°)
        let name = match[1];
        // Ğ¨ÑƒÑ€Ğ¾Ñ‡ĞºĞµ â†’ Ğ¨ÑƒÑ€Ğ¾Ñ‡ĞºĞ°, Ğ“Ğ°Ğ»Ğµ â†’ Ğ“Ğ°Ğ»Ñ
        if (name.endsWith('Ğµ') || name.endsWith('Ğ¸') || name.endsWith('Ñ‹') || name.endsWith('Ñƒ')) {
          name = name.slice(0, -1) + 'Ğ°';
        }
        addCharacter(name, undefined, 'Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ');
      }
    }
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  if (characters.length > 0) {
    console.log(`ğŸ­ Extracted ${characters.length} characters from chunk 0:`);
    for (const char of characters) {
      const source = char.description ? ` (${char.description})` : '';
      console.log(`   â€¢ ${char.name}${char.actor ? ` - ${char.actor}` : ''} [${char.gender}]${source}`);
    }
  } else {
    console.log(`âš ï¸ No characters found in chunk 0 - will use generic names`);
  }
  
  return {
    characters,
    extractedFromTimecode: '00:00:00:00',
    extractionTimestamp: new Date().toISOString(),
  };
}



