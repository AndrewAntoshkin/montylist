# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ

## –ü—Ä–æ–±–ª–µ–º–∞: Race Condition

–ü—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ 5 —á–∞–Ω–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∞ –≥–æ–Ω–∫–∞ –¥–∞–Ω–Ω—ã—Ö:

```
–ß–∞–Ω–∫ 5: READ chunk_progress_json ‚Üí status[5] = 'completed' ‚Üí WRITE
–ß–∞–Ω–∫ 7: READ chunk_progress_json ‚Üí status[7] = 'completed' ‚Üí WRITE (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–∞–Ω–∫–∞ 5!)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å ‚Üí `7/18` —á–∞–Ω–∫–æ–≤ –≤–º–µ—Å—Ç–æ `18/18`.

---

## –†–µ—à–µ–Ω–∏–µ: –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

### 1. SQL —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è PostgreSQL

```sql
-- supabase/migrations/20251213_atomic_chunk_update.sql
CREATE OR REPLACE FUNCTION update_chunk_status(
  p_video_id UUID,
  p_chunk_index INTEGER,
  p_status TEXT,
  p_error TEXT DEFAULT NULL
)
```

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç `FOR UPDATE` –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫–∏ –∏ `jsonb_set` –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

### 2. TypeScript –æ–±—ë—Ä—Ç–∫–∞

```typescript
// lib/supabase/chunk-status.ts
await updateChunkStatus(videoId, chunkIndex, 'completed');
```

–í—ã–∑—ã–≤–∞–µ—Ç RPC —Ñ—É–Ω–∫—Ü–∏—é, —Å fallback –Ω–∞ –æ–±—ã—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.

---

## –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å

### 1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –º–∏–≥—Ä–∞—Ü–∏—é –≤ Supabase

–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Supabase Dashboard ‚Üí SQL Editor** –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```sql
-- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
-- supabase/migrations/20251213_atomic_chunk_update.sql
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

```bash
# Ctrl+C –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ —Å npm run dev
npm run dev
```

### 3. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è

–î–ª—è —É–∂–µ –∑–∞—Å—Ç—Ä—è–≤—à–∏—Ö –≤–∏–¥–µ–æ:

```
http://localhost:3000/api/force-finalize?videoId=YOUR_VIDEO_ID
```

---

## –õ–∏–º–∏—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### Replicate API
- Predictions: 600 req/min ‚úÖ
- –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º: 5 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ ‚úÖ

### Gemini 3 Pro
- Max –≤–∏–¥–µ–æ: 45 –º–∏–Ω —Å –∞—É–¥–∏–æ ‚úÖ
- Max –≤–∏–¥–µ–æ –≤ –ø—Ä–æ–º–ø—Ç–µ: 10 ‚úÖ
- –ö–æ–Ω—Ç–µ–∫—Å—Ç: 1M —Ç–æ–∫–µ–Ω–æ–≤ ‚úÖ
- –ù–∞—à–∏ —á–∞–Ω–∫–∏: 3 –º–∏–Ω ‚Üí ~54K —Ç–æ–∫–µ–Ω–æ–≤ ‚úÖ

### –ù–∞—à–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| –ß–∞–Ω–∫–∏ | 3 –º–∏–Ω—É—Ç—ã |
| Overlap | 15 —Å–µ–∫—É–Ω–¥ |
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ | 5 —á–∞–Ω–∫–æ–≤ |
| API –∫–ª—é—á–µ–π | 5 |
| Timeout | 5 –º–∏–Ω—É—Ç/—á–∞–Ω–∫ |

---

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ

1. `lib/supabase/chunk-status.ts` - –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
2. `app/api/process-chunk/route.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å
3. `app/api/finalize-processing/route.ts` - —Å—á–∏—Ç–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î
4. `app/api/force-finalize/route.ts` - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
5. `supabase/migrations/20251213_atomic_chunk_update.sql` - SQL —Ñ—É–Ω–∫—Ü–∏—è



