# ‚úÖ FFmpeg Integration - –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø –≥–æ—Ç–æ–≤–∞!

## üîê –ë—ç–∫–∞–ø—ã —Å–æ–∑–¥–∞–Ω—ã

**–ë—ç–∫–∞–ø #1 (—Å–∞–º–∞—è —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è):**
- `backup/20251124_003142/`
- –î–æ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–ë—ç–∫–∞–ø #2 (—Ä–∞–±–æ—á–∞—è –≤–µ—Ä—Å–∏—è):** ‚≠ê
- `backup/working_version_20251128_224324/`
- –° —É–ª—É—á—à–µ–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
- ~418 –ø–ª–∞–Ω–æ–≤ –Ω–∞ 48 –º–∏–Ω
- **–û—Ç–∫–∞—Ç—ã–≤–∞–π—Ç–µ—Å—å —Å—é–¥–∞ –µ—Å–ª–∏ FFmpeg –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏—Ç—Å—è!**

---

## ‚ú® –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. FFmpeg Scene Detection (–ø–æ–ª–Ω–æ—Å—Ç—å—é) ‚úÖ
- `lib/scene-detection.ts` - –¥–µ—Ç–µ–∫—Ü–∏—è –≤—Å–µ—Ö —Å–∫–ª–µ–µ–∫
- `lib/gemini-prompt-with-scenes.ts` - –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–æ—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω
- `lib/parseGeminiWithScenes.ts` - –ø–∞—Ä—Å–µ—Ä –¥–ª—è FFmpeg —Ä–µ–∂–∏–º–∞
- `scripts/test-scene-detection.js` - —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

### 2. –£–ª—É—á—à–µ–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è ‚úÖ
- –ë—ã–ª–æ: —É–¥–∞–ª—è–ª–∞ 58% –ø–ª–∞–Ω–æ–≤ (—Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ!)
- –°—Ç–∞–ª–æ: —É–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–æ—á–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã (<0.5 —Å–µ–∫ + >90% –ø–æ—Ö–æ–∂–µ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ)

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ ‚úÖ
- `app/api/init-chunked-processing/route.ts` - –∑–∞–ø—É—Å–∫ FFmpeg
- `app/api/process-chunk/route.ts` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω + –Ω–æ–≤—ã–π –ø–∞—Ä—Å–µ—Ä

---

## üöÄ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

### –®–∞–≥ 1: –í–∫–ª—é—á–∏—Ç–µ FFmpeg –≤ .env.local

–°–æ–∑–¥–∞–π—Ç–µ/–æ—Ç–∫—Ä–æ–π—Ç–µ `.env.local` –∏ –¥–æ–±–∞–≤—å—Ç–µ:
```bash
USE_SCENE_DETECTION=true
SCENE_DETECTION_THRESHOLD=0.3
```

### –®–∞–≥ 2: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

```bash
# Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
npm run dev
```

### –®–∞–≥ 3: –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ö–û–†–û–¢–ö–û–ï —Ç–µ—Å—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ (2-5 –º–∏–Ω—É—Ç)

**–í–∞–∂–Ω–æ:** –ù–∞—á–Ω–∏—Ç–µ —Å –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –≤–∏–¥–µ–æ!

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
üé¨ FFmpeg Scene Detection is ENABLED
‚úÖ FFmpeg is available
üéûÔ∏è  Detected FPS: 24
üé¨ Starting FFmpeg scene detection...
‚úÖ Scene detection completed in 12.3s
üìä Total scenes found: 145

üé¨ Using FFmpeg detected scenes for chunk 0
‚úÖ Found 50 pre-detected scenes for this chunk
üìù Generated prompt WITH 50 detected scenes
üé¨ Parsing with FFmpeg detected scenes (50 scenes)
‚úÖ Gemini described all 50 FFmpeg-detected scenes
```

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ë—ã–ª–æ (Gemini-only):
- –ü–ª–∞–Ω–æ–≤: ~418 (–ø–æ—Å–ª–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏)
- –†–∞–∑—Ä—ã–≤—ã: –µ—Å—Ç—å (–ø—Ä–æ–ø—É—Å–∫–∏ 1-4 —Å–µ–∫)
- –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: —É–¥–∞–ª—è–ª–∞ 58%

### –°—Ç–∞–Ω–µ—Ç (FFmpeg + Gemini):
- –ü–ª–∞–Ω–æ–≤: ~900-1100 (–∫–∞–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º)
- –†–∞–∑—Ä—ã–≤—ã: 0 (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤—Å—Ç—ã–∫)
- –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: —É–¥–∞–ª–∏—Ç <10% (—Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã)

---

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

**1. –¢–∞–π–º–∫–æ–¥—ã –≤—Å—Ç—ã–∫?**
```
–ü–ª–∞–Ω 10: ... - 00:05:30:17
–ü–ª–∞–Ω 11: 00:05:30:17 - ...  ‚Üê –¥–æ–ª–∂–Ω–æ –¢–û–ß–ù–û —Å–æ–≤–ø–∞–¥–∞—Ç—å!
```

**2. –°–∫–æ–ª—å–∫–æ –ø–ª–∞–Ω–æ–≤?**
```
~900-1100 –ø–ª–∞–Ω–æ–≤ –Ω–∞ 48 –º–∏–Ω—É—Ç = ~18-23 –ø–ª–∞–Ω–∞/–º–∏–Ω ‚úÖ
```

**3. –ù–µ—Ç —Ä–∞–∑—Ä—ã–≤–æ–≤?**
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–ª–∞–Ω–æ–≤ –ø–æ–¥—Ä—è–¥ - –≤—Å–µ –¥–æ–ª–∂–Ω—ã —Å—Ç—ã–∫–æ–≤–∞—Ç—å—Å—è

**4. –î–∏–∞–ª–æ–≥–∏ –ø–æ–ª–Ω—ã–µ?**
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –Ω–µ –ø–æ—Ç–µ—Ä—è–Ω—ã —á–∞—Å—Ç–∏ —Ä–µ–ø–ª–∏–∫

---

## üîÑ –û—Ç–∫–∞—Ç –∫ —Ä–∞–±–æ—á–µ–π –≤–µ—Ä—Å–∏–∏

### –ï—Å–ª–∏ FFmpeg –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏—Ç—Å—è:

```bash
cd /Users/andrewaitken/carete-montage

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–±–æ—á—É—é –≤–µ—Ä—Å–∏—é (–æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞)
cp backup/working_version_20251128_224324/*.ts lib/ 2>/dev/null
cp backup/working_version_20251128_224324/init-chunked-processing.ts app/api/init-chunked-processing/route.ts
cp backup/working_version_20251128_224324/process-chunk.ts app/api/process-chunk/route.ts
cp backup/working_version_20251128_224324/finalize-processing.ts app/api/finalize-processing/route.ts
cp backup/working_version_20251128_224324/process-video-chunked.ts app/api/process-video-chunked/route.ts

echo "‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ: npm run dev"
```

–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫–ª—é—á–∏—Ç–µ —Ñ–ª–∞–≥:
```bash
USE_SCENE_DETECTION=false
```

---

## ‚öôÔ∏è –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:
1. `lib/scene-detection.ts` - FFmpeg –¥–µ—Ç–µ–∫—Ü–∏—è
2. `lib/gemini-prompt-with-scenes.ts` - —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç
3. `lib/parseGeminiWithScenes.ts` - –ø–∞—Ä—Å–µ—Ä –¥–ª—è FFmpeg —Ä–µ–∂–∏–º–∞

### –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. `lib/video-chunking.ts` - –º–µ–Ω–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
2. `app/api/init-chunked-processing/route.ts` - –∑–∞–ø—É—Å–∫ FFmpeg
3. `app/api/process-chunk/route.ts` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ FFmpeg –¥–∞–Ω–Ω—ã—Ö

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–í–∫–ª—é—á–∏—Ç–µ —Ñ–ª–∞–≥** –≤ `.env.local`
2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä**
3. **–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤–∏–¥–µ–æ** (2-5 –º–∏–Ω)
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç**
5. **–ï—Å–ª–∏ —Ö–æ—Ä–æ—à–æ** ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –≤—Å–µ—Ö –≤–∏–¥–µ–æ!
6. **–ï—Å–ª–∏ –ø–ª–æ—Ö–æ** ‚Üí –æ—Ç–∫–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä–∞–±–æ—á–µ–π –≤–µ—Ä—Å–∏–∏

---

**–í—Å–µ –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üöÄ

**–ë—ç–∫–∞–ø —Ä–∞–±–æ—á–µ–π –≤–µ—Ä—Å–∏–∏:** `backup/working_version_20251128_224324/`
**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:** –°–º. `RESTORE_WORKING_VERSION.md`









