# üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É–ª–∞ Replicate API –∫–ª—é—á–µ–π

## –ß—Ç–æ —ç—Ç–æ –¥–∞–µ—Ç?

‚úÖ **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞–Ω–∫–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ  
‚úÖ **–û–±—Ö–æ–¥ –ª–∏–º–∏—Ç–æ–≤** - –∫–∞–∂–¥—ã–π –∫–ª—é—á –∏–º–µ–µ—Ç —Å–≤–æ–∏ rate limits  
‚úÖ **–ë—ã—Å—Ç—Ä–µ–µ –≤ 3-5 —Ä–∞–∑** - –≤–º–µ—Å—Ç–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞** - —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É  

## üìã –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –≤ .env.local

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `.env.local` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤–∞—à–∏ 5 Replicate API –∫–ª—é—á–µ–π:

```bash
# Replicate API Keys Pool (–¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏)
REPLICATE_API_TOKEN_1=r8_your_first_token_here
REPLICATE_API_TOKEN_2=r8_your_second_token_here
REPLICATE_API_TOKEN_3=r8_your_third_token_here
REPLICATE_API_TOKEN_4=r8_your_fourth_token_here
REPLICATE_API_TOKEN_5=r8_your_fifth_token_here

# –°—Ç–∞—Ä—ã–π –∫–ª—é—á (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
# REPLICATE_API_TOKEN=r8_...
```

**–í–∞–∂–Ω–æ:**
- –§–æ—Ä–º–∞—Ç: `REPLICATE_API_TOKEN_1`, `REPLICATE_API_TOKEN_2`, –∏ —Ç.–¥.
- –ù–æ–º–µ—Ä–∞ –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É –Ω–∞—á–∏–Ω–∞—è —Å 1
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ 10 –∫–ª—é—á–µ–π (—Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `REPLICATE_API_TOKEN_1` –¥–æ `REPLICATE_API_TOKEN_10`)

## üöÄ –®–∞–≥ 2: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä

–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–µ–π **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ dev —Å–µ—Ä–≤–µ—Ä:

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–µ–∫—É—â–∏–π —Å–µ—Ä–≤–µ—Ä (Ctrl+C)
# –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞:
npm run dev
```

## ‚úÖ –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –≤ –ª–æ–≥–∞—Ö:

```
üîë Initialized Replicate pool with 5 API key(s)
```

–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∏–¥–µ–æ –±—É–¥—É—Ç –ª–æ–≥–∏:

```
üîë Using API key #1 (1 active requests)
üîë Using API key #2 (1 active requests)
üîë Using API key #3 (1 active requests)
...
üîì Released API key #1 (0 active requests)
```

## üìä –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

**–í–∞–∂–Ω–æ:** 1 —á–∞–Ω–∫ = 20 –º–∏–Ω—É—Ç –≤–∏–¥–µ–æ, ~2 –º–∏–Ω—É—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –î–æ (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞):

```
–í–∏–¥–µ–æ 60 –º–∏–Ω—É—Ç: –ß–∞–Ω–∫ 0 ‚Üí –ß–∞–Ω–∫ 1 ‚Üí –ß–∞–Ω–∫ 2
                [‚ñà‚ñà‚ñà‚ñà][‚ñà‚ñà‚ñà‚ñà][‚ñà‚ñà‚ñà‚ñà]
                –í—Ä–µ–º—è: ~6 –º–∏–Ω—É—Ç
```

### –ü–æ—Å–ª–µ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å 5 –∫–ª—é—á–∞–º–∏):

```
–í–∏–¥–µ–æ 60 –º–∏–Ω—É—Ç: 
  –ß–∞–Ω–∫ 0 [‚ñà‚ñà‚ñà‚ñà] ‚Üí –∫–ª—é—á #1
  –ß–∞–Ω–∫ 1 [‚ñà‚ñà‚ñà‚ñà] ‚Üí –∫–ª—é—á #2
  –ß–∞–Ω–∫ 2 [‚ñà‚ñà‚ñà‚ñà] ‚Üí –∫–ª—é—á #3
  
–í—Ä–µ–º—è: ~2 –º–∏–Ω—É—Ç—ã (–≤ 3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ!)
```

### –î–ª–∏–Ω–Ω–æ–µ –≤–∏–¥–µ–æ (100 –º–∏–Ω—É—Ç = 5 —á–∞–Ω–∫–æ–≤):

```
–î–æ:  –ß–∞–Ω–∫ 0 ‚Üí –ß–∞–Ω–∫ 1 ‚Üí –ß–∞–Ω–∫ 2 ‚Üí –ß–∞–Ω–∫ 3 ‚Üí –ß–∞–Ω–∫ 4
     [‚ñà‚ñà‚ñà‚ñà][‚ñà‚ñà‚ñà‚ñà][‚ñà‚ñà‚ñà‚ñà][‚ñà‚ñà‚ñà‚ñà][‚ñà‚ñà‚ñà‚ñà]
     –í—Ä–µ–º—è: ~10 –º–∏–Ω—É—Ç

–ü–æ—Å–ª–µ: –í—Å–µ 5 —á–∞–Ω–∫–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
     –ß–∞–Ω–∫ 0 [‚ñà‚ñà‚ñà‚ñà] ‚Üí –∫–ª—é—á #1
     –ß–∞–Ω–∫ 1 [‚ñà‚ñà‚ñà‚ñà] ‚Üí –∫–ª—é—á #2
     –ß–∞–Ω–∫ 2 [‚ñà‚ñà‚ñà‚ñà] ‚Üí –∫–ª—é—á #3
     –ß–∞–Ω–∫ 3 [‚ñà‚ñà‚ñà‚ñà] ‚Üí –∫–ª—é—á #4
     –ß–∞–Ω–∫ 4 [‚ñà‚ñà‚ñà‚ñà] ‚Üí –∫–ª—é—á #5
     
–í—Ä–µ–º—è: ~2 –º–∏–Ω—É—Ç—ã (–≤ 5 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ!)
```

### –ù–µ—Å–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:

```
–í–∏–¥–µ–æ 1 (60 –º–∏–Ω): –ß–∞–Ω–∫–∏ 0-2 –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–ª—é—á–∏ #1-3
–í–∏–¥–µ–æ 2 (100 –º–∏–Ω): –ß–∞–Ω–∫–∏ 0-4 –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–ª—é—á–∏ #1-5
–í–∏–¥–µ–æ 3 (40 –º–∏–Ω): –ß–∞–Ω–∫–∏ 0-1 –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–ª—é—á–∏ #1-2

–í—Å–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ!
–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–∞–ª–∞–Ω—Å–∏—Ä—É–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –º–µ–∂–¥—É –∫–ª—é—á–∞–º–∏!
```

## üéØ –ê–ª–≥–æ—Ä–∏—Ç–º –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Least Loaded** –∞–ª–≥–æ—Ä–∏—Ç–º:

1. –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —á–∞–Ω–∫–∞ —Å–∏—Å—Ç–µ–º–∞ –≤—ã–±–∏—Ä–∞–µ—Ç –∫–ª—é—á —Å –Ω–∞–∏–º–µ–Ω—å—à–µ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π
2. –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª—é—á–∞
3. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ - —É–º–µ–Ω—å—à–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫
4. –°–ª–µ–¥—É—é—â–∏–π —á–∞–Ω–∫ –ø–æ–ª—É—á–∏—Ç —Å–∞–º—ã–π —Å–≤–æ–±–æ–¥–Ω—ã–π –∫–ª—é—á

**–ü—Ä–∏–º–µ—Ä:**
```
–ö–ª—é—á #1: 2 –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞
–ö–ª—é—á #2: 0 –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤  ‚Üê –ë—É–¥–µ—Ç –≤—ã–±—Ä–∞–Ω
–ö–ª—é—á #3: 1 –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å
–ö–ª—é—á #4: 3 –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞
–ö–ª—é—á #5: 1 –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ batch size

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç **5 —á–∞–Ω–∫–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ** (–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∫–ª—é—á–µ–π).

–ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å, –æ—Ç–∫—Ä–æ–π—Ç–µ `app/api/process-all-chunks/route.ts`:

```typescript
const BATCH_SIZE = 5; // –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ –Ω—É–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ï—Å–ª–∏ 5 –∫–ª—é—á–µ–π ‚Üí BATCH_SIZE = 5
- –ï—Å–ª–∏ 3 –∫–ª—é—á–∞ ‚Üí BATCH_SIZE = 3
- –ï—Å–ª–∏ 10 –∫–ª—é—á–µ–π ‚Üí BATCH_SIZE = 10

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Rate Limits:** –ö–∞–∂–¥—ã–π Replicate –∞–∫–∫–∞—É–Ω—Ç –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç—ã –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤. –û–±—ã—á–Ω–æ —ç—Ç–æ ~5-10 –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –∫–ª—é—á.

2. **–°—Ç–æ–∏–º–æ—Å—Ç—å:** –ë–æ–ª—å—à–µ –∫–ª—é—á–µ–π = –±—ã—Å—Ç—Ä–µ–µ –æ–±—Ä–∞–±–æ—Ç–∫–∞, –Ω–æ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Å—Ç–æ–∏—Ç –¥–µ–Ω–µ–≥. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –±–∞–ª–∞–Ω—Å–æ–º –Ω–∞ –≤—Å–µ—Ö –∞–∫–∫–∞—É–Ω—Ç–∞—Ö.

3. **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ª–∏–º–∏—Ç—ã:** –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ç–∏—Ä—ã Replicate, —É—á–∏—Ç—ã–≤–∞–π—Ç–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞.

4. **Retry –ª–æ–≥–∏–∫–∞:** –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ E6716 –æ—à–∏–±–∫–∞—Ö (–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã Replicate).

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "No Replicate API tokens found"

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏–º–µ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: `REPLICATE_API_TOKEN_1`, `REPLICATE_API_TOKEN_2`
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ñ–∞–π–ª `.env.local` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ dev —Å–µ—Ä–≤–µ—Ä

### –ü—Ä–æ–±–ª–µ–º–∞: Rate limit errors (429)

**–†–µ—à–µ–Ω–∏–µ:**
- –£–º–µ–Ω—å—à–∏—Ç–µ `BATCH_SIZE`
- –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ API –∫–ª—é—á–µ–π
- –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —á–∞–Ω–∫–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ - –∫–∞–∫–æ–π –∫–ª—é—á –≤—ã–¥–∞–µ—Ç –æ—à–∏–±–∫–∏
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞ –≤—Å–µ—Ö Replicate –∞–∫–∫–∞—É–Ω—Ç–∞—Ö
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ –∫–ª—é—á–∏ –≤–∞–ª–∏–¥–Ω—ã

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏:

```bash
# –£—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
‚úÖ Chunk 0 completed: 15 scenes
üîì Released API key #1 (0 active requests)

# –û—à–∏–±–∫–∏
‚ùå Chunk 2 failed: E6716 error
‚ö†Ô∏è  Chunk 2 E6716 on attempt 1. Retrying in 5000ms...

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞—Ç—á–µ–π
üìä Batch 1 completed: 5 successful, 0 failed
```

## üéâ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å –≤–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å:
- ‚úÖ –ù–µ—Å–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚úÖ –ß–∞–Ω–∫–∏ –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–µ–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏
- ‚úÖ –î–æ 5 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º —Ä–∞–Ω—å—à–µ!

---

**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-11-17  
**–í–µ—Ä—Å–∏—è:** 2.0 (Parallel Processing)

