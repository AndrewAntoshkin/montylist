/**
 * Профессиональный промпт для монтажного листа по ГОСТ
 * 
 * Основано на анализе реального монтажного листа:
 * - ~22 плана/минуту (каждая монтажная склейка!)
 * - Раздельные таймкоды (начало и конец)
 * - Строгий формат диалогов
 * - НДП при титрах на экране
 * - ЗК/ГЗ для голоса за кадром
 */

export const SIMPLE_MONTAGE_PROMPT = `Создай ПРОФЕССИОНАЛЬНЫЙ монтажный лист по ГОСТ.

══════════════════════════════════════════════════════════════════
⚠️ КРИТИЧНО: ДЕТАЛИЗАЦИЯ ~20-25 ПЛАНОВ НА МИНУТУ!
══════════════════════════════════════════════════════════════════

КАЖДАЯ монтажная склейка (смена ракурса/кадра) = ОТДЕЛЬНЫЙ план!
Даже короткие кадры по 1-2 секунды - это отдельные планы!

Примеры коротких планов:
- 00:02:17:01 - 00:02:18:00 | Кр. | Тома кивает | Музыка
- 00:02:18:00 - 00:02:19:13 | Кр. | Галя качает головой | Музыка
- 00:02:19:13 - 00:02:20:14 | Кр. | Тома смотрит на Галю | Музыка

НЕ ОБЪЕДИНЯЙ несколько кадров в один план!

══════════════════════════════════════════════════════════════════
🎬 ЗАСТАВКА (OPENING CREDITS)
══════════════════════════════════════════════════════════════════

Первые ~60-90 секунд = ЗАСТАВКА. Это ОДИН длинный план!
Описание включает ВСЁ что происходит в заставке:

Пример:
**00:00:04:09 - 00:01:06:13**
*   **План:** Ср. НДП
*   **Содержание:** Заставка. На фоне лица появляется титр: Телеканал "Домашний" представляет. Шурочка рисует сердце на стекле. Появляется титр «Шурочка. Татьяна Рыбинец». Бэлла с гантелями. Титр «Бэлла. Полина Ганшина». [и т.д.]
*   **Диалоги/Музыка:** Музыка

══════════════════════════════════════════════════════════════════
📋 ТИП ПЛАНА (с НДП при титрах!)
══════════════════════════════════════════════════════════════════

- **Кр.** = крупный план (лицо)
- **Ср.** = средний план (по пояс)
- **Общ.** = общий план (вся сцена)
- **Деталь** = деталь (руки, предмет)
- **НДП** = надпись на плане (титры на экране)

КОМБИНАЦИИ при титрах:
- Кр. НДП (крупный план + титры на экране)
- Ср. НДП (средний план + титры на экране)

Пример:
00:01:16:12 - 00:01:18:05 | Кр. НДП | К зеркалу подходит Тома. Титр «Татьяна Елена Чекмазова»

══════════════════════════════════════════════════════════════════
🎭 ПЕРСОНАЖИ
══════════════════════════════════════════════════════════════════

ТИТРЫ указывают: "Имя персонажа – Имя актёра"
- "Галина – Полина Нечитайло" → используй ГАЛЯ
- "Тома – Елена Доронина" → используй ТОМА
- "Юсеф – Олег Чудницов" → используй ЮСЕФ

СЛУШАЙ диалоги! Если говорят "Тома, подойди" - это ТОМА.

══════════════════════════════════════════════════════════════════
💬 ФОРМАТ ДИАЛОГОВ (строго по ГОСТ!)
══════════════════════════════════════════════════════════════════

Формат: ИМЯ (с новой строки) текст

✅ ПРАВИЛЬНО:
ГАЛЯ
Проходите. Присаживайтесь

ТОМА
А вы знаете, у нас такая проблема?

✅ ГОЛОС ЗА КАДРОМ (когда говорящего не видно):
ГАЛЯ ЗК
Он тогда меня просто загонял.

ГАЛЯ ГЗ
(альтернативная запись голоса за кадром)

✅ КОГДА НЕТ ДИАЛОГОВ:
- Музыка (если играет музыка)
- Шум воды (если специфичный звук)
- Смех (если смеются)

❌ НЕПРАВИЛЬНО:
ГАЛЯ: Привет! (БЕЗ двоеточия!)
Диалоги: ГАЛЯ говорит... (БЕЗ слова "Диалоги:")

══════════════════════════════════════════════════════════════════
🎥 ОПИСАНИЕ КАДРА
══════════════════════════════════════════════════════════════════

Кратко, но информативно:
- КТО в кадре (имя персонажа)
- ЧТО делает (действие)
- ГДЕ находится (локация, если меняется)
- ТИТРЫ (если есть на экране)

Примеры:
- Галя говорит в кадре, улыбается
- Тома моет руки
- Юсеф сидит за столом, смотрит в меню
- На столе лежит меню, Юсеф изучает его
- Камера переходит на клиентку. Титр «Жены: Анна Татренко...»

══════════════════════════════════════════════════════════════════
📝 ФОРМАТ ОТВЕТА
══════════════════════════════════════════════════════════════════

**ЧЧ:ММ:СС:КК - ЧЧ:ММ:СС:КК**
*   **План:** Кр.
*   **Содержание:** Галя говорит в кадре.
*   **Диалоги/Музыка:** 
ГАЛЯ
Привет! Как дела?

**ЧЧ:ММ:СС:КК - ЧЧ:ММ:СС:КК**
*   **План:** Кр.
*   **Содержание:** Тома слушает Галю.
*   **Диалоги/Музыка:** Музыка

══════════════════════════════════════════════════════════════════
⚠️ ВАЖНО: КАЖДАЯ СМЕНА КАДРА = НОВЫЙ ПЛАН!
══════════════════════════════════════════════════════════════════

Для 3-минутного видео должно быть ~60-75 планов!
НЕ пропускай короткие кадры. НЕ объединяй разные ракурсы.
Опиши КАЖДУЮ монтажную склейку!`;


/**
 * Промпт с FFmpeg таймкодами (когда сцены уже определены)
 * FFmpeg определил точные границы планов - Gemini только описывает содержание
 * 
 * @param scenes - список сцен с таймкодами
 * @param chunkIndex - индекс чанка
 * @param totalChunks - общее количество чанков
 * @param characterRegistryBlock - готовый блок с реестром персонажей (или пустая строка)
 */
export function createPromptWithFFmpegScenes(
  scenes: Array<{ start_timecode: string; end_timecode: string }>,
  chunkIndex: number,
  totalChunks: number,
  characterRegistryBlock: string = ''
): string {
  const sceneList = scenes
    .map((s, i) => `${i + 1}. ${s.start_timecode} - ${s.end_timecode}`)
    .join('\n');

  const hasKnownCharacters = characterRegistryBlock.length > 0;

  return `Опиши ${scenes.length} планов этого видео.

══════════════════════════════════════════════════════════════════
⚠️ КРИТИЧЕСКИ ВАЖНО: ТАЙМКОДЫ ФИКСИРОВАНЫ!
══════════════════════════════════════════════════════════════════

Таймкоды определены автоматически и являются ТОЧНЫМИ.
НЕ МЕНЯЙ, НЕ КОРРЕКТИРУЙ, НЕ ИСПРАВЛЯЙ таймкоды!
Просто ОПИШИ что происходит в каждом временном интервале.

📋 СПИСОК ПЛАНОВ (${scenes.length} шт.):
${sceneList}
${characterRegistryBlock}
══════════════════════════════════════════════════════════════════
📝 ТВОЯ ЗАДАЧА: Для КАЖДОГО плана из списка напиши:
══════════════════════════════════════════════════════════════════

1. **План:** Тип (Кр./Ср./Общ./Деталь) + НДП если есть титры на экране
2. **Содержание:** Кто в кадре и что делает (1-2 предложения)
3. **Диалоги/Музыка:** Дословный текст реплик ИЛИ "Музыка"

══════════════════════════════════════════════════════════════════
🎭 ПЕРСОНАЖИ
══════════════════════════════════════════════════════════════════

СЛУШАЙ ВНИМАТЕЛЬНО диалоги и ЧИТАЙ титры:
- Титр "Галина – Актриса" → персонаж ГАЛЯ
- Кто-то говорит "Тома, подойди!" → это ТОМА
${hasKnownCharacters ? '- ВСЕ имена персонажей указаны ВЫШЕ в реестре — используй их!' : '- До первого упоминания: ЖЕНЩИНА/МУЖЧИНА (но ИЩИ имена в титрах!)'}

══════════════════════════════════════════════════════════════════
💬 ФОРМАТ ДИАЛОГОВ (строго БЕЗ двоеточия!)
══════════════════════════════════════════════════════════════════

✅ ПРАВИЛЬНО:
ГАЛЯ
Привет! Как дела?

❌ НЕПРАВИЛЬНО:
ГАЛЯ: Привет! Как дела?

Голос за кадром: ГАЛЯ ЗК

══════════════════════════════════════════════════════════════════
📝 ФОРМАТ ОТВЕТА (повтори таймкод из списка ТОЧНО!)
══════════════════════════════════════════════════════════════════

**${scenes[0]?.start_timecode || '00:00:00:00'} - ${scenes[0]?.end_timecode || '00:00:00:00'}**
*   **План:** Кр.
*   **Содержание:** Персонаж разговаривает в кадре.
*   **Диалоги/Музыка:** 
ПЕРСОНАЖ
Привет!

... (опиши все ${scenes.length} планов по порядку) ...

${totalChunks > 1 ? `\n⚠️ Это часть ${chunkIndex + 1} из ${totalChunks}. Опиши ВСЕ ${scenes.length} планов!` : ''}`;
}


/**
 * Промпт когда Gemini сам находит сцены
 * 
 * @param chunkIndex - индекс чанка
 * @param startTimecode - начало чанка
 * @param endTimecode - конец чанка
 * @param totalChunks - общее количество чанков
 * @param characterRegistryBlock - готовый блок с реестром персонажей (или пустая строка)
 */
export function createSimpleChunkPrompt(
  chunkIndex: number,
  startTimecode: string,
  endTimecode: string,
  totalChunks: number,
  characterRegistryBlock: string = ''
): string {
  // Рассчитываем ожидаемое количество планов (~22 плана/минуту)
  const [sh, sm, ss] = startTimecode.split(':').map(Number);
  const [eh, em, es] = endTimecode.split(':').map(Number);
  const startSec = sh * 3600 + sm * 60 + ss;
  const endSec = eh * 3600 + em * 60 + es;
  const durationMin = (endSec - startSec) / 60;
  const expectedPlans = Math.round(durationMin * 22);

  const hasKnownCharacters = characterRegistryBlock.length > 0;

  if (totalChunks > 1) {
    return `${SIMPLE_MONTAGE_PROMPT}

══════════════════════════════════════════════════════════════════
⚠️ ЭТО ЧАСТЬ ${chunkIndex + 1} ИЗ ${totalChunks}
══════════════════════════════════════════════════════════════════

📍 Диапазон таймкодов: ${startTimecode} - ${endTimecode}
📊 Ожидаемое количество планов: ~${expectedPlans} (при ~22 планах/минуту)
${characterRegistryBlock}
ВАЖНО:
1. Читай таймкод с ПЛАШКИ в видео (burn-in timecode)
2. Таймкоды должны быть в диапазоне ${startTimecode.substring(0,5)}... до ${endTimecode.substring(0,5)}...
3. Этот фрагмент ~${durationMin.toFixed(1)} минуты = должно быть ~${expectedPlans} планов!
4. КАЖДАЯ смена кадра = отдельный план (даже 1 секунда)
${hasKnownCharacters ? '5. Используй ИМЕНА из реестра персонажей выше!' : ''}

${chunkIndex === 0 ? '🎬 ПЕРВЫЙ ЧАНК: Если есть заставка - опиши как ОДИН длинный план!\n   ВАЖНО: Извлеки имена персонажей из титров!' : ''}

НЕ ОСТАНАВЛИВАЙСЯ! Опиши ВСЕ ${expectedPlans}+ планов до конца!`;
  }
  
  return SIMPLE_MONTAGE_PROMPT;
}


/**
 * Промпт для валидации (без изменений)
 */
export function createValidationPrompt(
  totalPlans: number,
  samplePlans: Array<{
    plan_number: number;
    start_timecode: string;
    end_timecode: string;
    plan_type: string;
    dialogues: string;
    description: string;
  }>,
  knownIssues: string[]
): string {
  const plansSample = samplePlans.map(p => 
    `План ${p.plan_number}: ${p.start_timecode} - ${p.end_timecode}
    Тип: ${p.plan_type}
    Диалоги: ${p.dialogues?.substring(0, 100) || 'Музыка'}
    Содержание: ${p.description?.substring(0, 100)}`
  ).join('\n\n');

  const issuesList = knownIssues.length > 0 
    ? `\nИЗВЕСТНЫЕ ПРОБЛЕМЫ:\n${knownIssues.map(i => `- ${i}`).join('\n')}`
    : '';

  return `Проверь качество монтажного листа (${totalPlans} планов).
${issuesList}

ОБРАЗЕЦ:
${plansSample}

ПРОВЕРЬ:
1. Таймкоды идут встык?
2. Формат диалогов правильный?
3. Типы планов корректные?

ОТВЕТ (JSON):
{
  "isValid": true/false,
  "score": 0-100,
  "issues": [{"planNumber": 1, "issue": "описание"}],
  "summary": "краткое резюме"
}`;
}


/**
 * Промпт для исправления (упрощён)
 */
export function createFixPrompt(
  plans: Array<{
    id: string;
    plan_number: number;
    start_timecode: string;
    end_timecode: string;
    plan_type: string;
    dialogues: string;
    description: string;
  }>,
  issueType: 'dialogues' | 'characters' | 'timecodes'
): string {
  const plansList = plans.map(p => 
    `ID: ${p.id} | План ${p.plan_number}: ${p.start_timecode}
    Диалоги: ${p.dialogues || '(пусто)'}
    Содержание: ${p.description}`
  ).join('\n---\n');

  const instructions: Record<string, string> = {
    dialogues: 'Убери двоеточия после имён. Имена ЗАГЛАВНЫМИ.',
    characters: 'Замени "ЖЕНЩИНА" на реальное имя из титров.',
    timecodes: 'Исправь разрывы в таймкодах.'
  };

  return `ИСПРАВЬ ${issueType}:
${instructions[issueType]}

ПЛАНЫ:
${plansList}

ОТВЕТ (JSON):
[{"id": "uuid", "dialogues": "исправленный текст"}]`;
}



