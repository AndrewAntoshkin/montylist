# üé§ –ê–Ω–∞–ª–∏–∑ –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π

## –í–æ–ø—Ä–æ—Å—ã

1. **–†–∞–∑–ª–∏—á–∞–µ–º –ª–∏ –º—ã –≤—Å–µ –≥–æ–ª–æ—Å–∞?**
2. **–û–ø—Ä–µ–¥–µ–ª—è–µ–º –ª–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–º—ë–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ú–µ–Ω–µ–¥–∂–µ—Ä" –¥–ª—è –ò–û–°–ò–§)?**

---

## 1. –†–∞–∑–ª–∏—á–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤ (Diarization)

### AssemblyAI Diarization

**–§–∞–π–ª:** `lib/full-audio-diarization.ts`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```typescript
speakers_expected: Math.min(maxSpeakers, 10)  // –ú–∞–∫—Å–∏–º—É–º 10 —Å–ø–∏–∫–µ—Ä–æ–≤
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ 10 —Å–ø–∏–∫–µ—Ä–æ–≤
- –ï—Å–ª–∏ –≤ —Ñ–∏–ª—å–º–µ –±–æ–ª—å—à–µ 10 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–∫–æ–ª—å–∫–æ —Å–ø–∏–∫–µ—Ä–æ–≤ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤–∏–¥–µ–æ
- –ï—Å–ª–∏ –±–æ–ª—å—à–µ 10, –Ω—É–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å `maxSpeakers`

**–†–µ—à–µ–Ω–∏–µ:**
- –£–≤–µ–ª–∏—á–∏—Ç—å `maxSpeakers` –¥–æ 15-20 –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∏–ª—å–º–æ–≤
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `speakers_expected: null` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è

---

## 2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏–º—ë–Ω

### –§—É–Ω–∫—Ü–∏—è `calibrateSpeakersByNameMentions`

**–§–∞–π–ª:** `lib/face-speaker-binding.ts` (—Å—Ç—Ä–æ–∫–∏ 300-368)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ò—â–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–º—ë–Ω –≤ —Ç–µ–∫—Å—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ì–∞–ª—å!", "–í–∞–ª—è")
2. –ï—Å–ª–∏ Speaker A –≥–æ–≤–æ—Ä–∏—Ç "–ì–∞–ª—å!", –∞ —Å–ª–µ–¥—É—é—â–∏–º –æ—Ç–≤–µ—á–∞–µ—Ç Speaker B, —Ç–æ Speaker B = –ì–ê–õ–ò–ù–ê
3. –ò—â–µ—Ç —Å–∞–º–æ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é: "–Ø –ì–∞–ª—è", "–º–µ–Ω—è –∑–æ–≤—É—Ç –ì–∞–ª—è"

**–ü—Ä–æ–±–ª–µ–º–∞:**
- ‚ö†Ô∏è –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `init-processing-v5`!
- ‚ö†Ô∏è –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–æ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ú–µ–Ω–µ–¥–∂–µ—Ä" –¥–ª—è –ò–û–°–ò–§)

**–†–µ—à–µ–Ω–∏–µ:**
1. –î–æ–±–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `calibrateSpeakersByNameMentions` –≤ `init-processing-v5`
2. –†–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–∏—Å–∫ –¥–ª—è —Ä–æ–ª–µ–π:
   - "–ú–µ–Ω–µ–¥–∂–µ—Ä" ‚Üí –ò–û–°–ò–§
   - "–î–∏—Ä–µ–∫—Ç–æ—Ä" ‚Üí ...
   - –ò —Ç.–¥.

---

## 3. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–æ–ª–µ–π

### –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ò–û–°–ò–§ –º–æ–∂–µ—Ç –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è "–ú–µ–Ω–µ–¥–∂–µ—Ä" –≤ –≤–∏–¥–µ–æ
- –ù–æ "–ú–µ–Ω–µ–¥–∂–µ—Ä" –Ω–µ –≤ —Å–ø–∏—Å–∫–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–º—ë–Ω

**–†–µ—à–µ–Ω–∏–µ:**
1. –î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª–∏ –≤ `NAME_VARIANTS`:
   ```typescript
   '–ò–û–°–ò–§': ['–Æ–°–ï–§', '–Æ–°–£–§', '–Æ–°–ò–ö', '–ú–ï–ù–ï–î–ñ–ï–†'],
   ```

2. –ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ —Ä–æ–ª–µ–π:
   ```typescript
   const ROLE_TO_CHARACTER: Record<string, string> = {
     '–ú–ï–ù–ï–î–ñ–ï–†': '–ò–û–°–ò–§',
     '–î–ò–†–ï–ö–¢–û–†': '...',
     ...
   };
   ```

3. –†–∞—Å—à–∏—Ä–∏—Ç—å `calibrateSpeakersByNameMentions` –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ä–æ–ª–µ–π

---

## 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ init-processing-v5

### –¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å

1. ‚úÖ –ü–æ–ª–Ω–∞—è –¥–∏–∞—Ä–∏–∑–∞—Ü–∏—è (AssemblyAI)
2. ‚úÖ ASR‚ÜîScript alignment
3. ‚úÖ Voice embeddings (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. ‚úÖ Face clustering
5. ‚úÖ Auto-binding faces
6. ‚ùå **–ù–ï–¢:** Name mention calibration

### –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å

–ü–æ—Å–ª–µ —à–∞–≥–∞ 3 (ASR‚ÜîScript alignment), –¥–æ–±–∞–≤–∏—Ç—å:

```typescript
// –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –ø–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è–º –∏–º—ë–Ω
if (hasScript && fullDiarizationWords.length > 0) {
  const { calibrateSpeakersByNameMentions } = await import('@/lib/face-speaker-binding');
  
  const nameMentionMapping = calibrateSpeakersByNameMentions(
    fullDiarizationWords.map(w => ({
      text: w.text,
      start: w.startMs,
      end: w.endMs,
      speaker: w.speaker,
    })),
    scriptData.characters
  );
  
  // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ mapper
  for (const [speakerId, characterName] of nameMentionMapping) {
    speakerCharacterMapper.addNameMention(speakerId, characterName, 0);
  }
}
```

---

## 5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `calibrateSpeakersByNameMentions` –≤ `init-processing-v5`
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä–æ–ª–µ–π (–ú–ï–ù–ï–î–ñ–ï–† ‚Üí –ò–û–°–ò–§)
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∏–∫–µ—Ä–æ–≤ (—É–≤–µ–ª–∏—á–∏—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
2. –£–ª—É—á—à–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π (–Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä—è–º—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è)
3. –£—á–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–∫—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç, –∫–æ–º—É –≥–æ–≤–æ—Ä—è—Ç)

---

## –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
2025-01-15
