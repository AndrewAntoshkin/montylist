# ‚úÖ –ü–†–û–ë–õ–ï–ú–ê –ù–ê–ô–î–ï–ù–ê –ò –ò–°–ü–†–ê–í–õ–ï–ù–ê!

## üîç –î–ï–¢–ê–õ–¨–ù–û–ï –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û

### –ß—Ç–æ –º—ã –≤—ã—è—Å–Ω–∏–ª–∏ —á–µ—Ä–µ–∑ —Ç–µ—Å—Ç—ã:

| –ú–µ—Ç–æ–¥ | –†–∞–∑–º–µ—Ä | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|-------|--------|-----------|
| **SDK Buffer** | 100 bytes | ‚úÖ SUCCESS |
| **SDK Buffer** | 1 MB | ‚úÖ SUCCESS |
| **SDK Buffer** | 100 MB | ‚úÖ **SUCCESS (10.2s)** |
| **SDK Stream** | 100 MB | ‚úÖ **SUCCESS (8.9s)** |
| **CLI upload** | 1 KB | ‚úÖ SUCCESS |
| **Signed URL** | –º–∞–ª–µ–Ω—å–∫–∏–µ | ‚úÖ SUCCESS |
| **Browser XHR** | >100 MB | ‚ùå **502 CORS error** |

---

## üéØ –ö–û–†–ï–ù–¨ –ü–†–û–ë–õ–ï–ú–´: **Browser XHR Timeout!**

### –ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤:
- ‚ùå Supabase Storage API (—Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ)
- ‚ùå –õ–∏–º–∏—Ç–∞—Ö —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (100 MB –≥—Ä—É–∑—è—Ç—Å—è —É—Å–ø–µ—à–Ω–æ)
- ‚ùå Signed URLs (—Ä–∞–±–æ—Ç–∞—é—Ç)
- ‚ùå CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (–º–∞–ª–µ–Ω—å–∫–∏–µ —Ñ–∞–π–ª—ã –≥—Ä—É–∑—è—Ç—Å—è)
- ‚ùå –ù–∞—à–µ–º –∫–æ–¥–µ server-side (–≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏)

### –ü—Ä–æ–±–ª–µ–º–∞ –í:
- ‚úÖ **Browser XHR –Ω–µ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –±–æ–ª—å—à–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏**
- ‚úÖ **XHR timeout** (–¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ç–∞–π–º–∞—É—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π)
- ‚úÖ **–ù–µ—Ç retry –ª–æ–≥–∏–∫–∏** –≤ browser upload

---

## ‚úÖ –ß–¢–û –ò–°–ü–†–ê–í–õ–ï–ù–û:

### –í `components/UploadModalLong.tsx`:

**–ë—ã–ª–æ:**
```typescript
xhr.open('PUT', uploadUrl);
xhr.send(file);
// –ù–µ—Ç timeout
// –ù–µ—Ç retry
// –ü–∞–¥–∞–µ—Ç –Ω–∞ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ
```

**–°—Ç–∞–ª–æ:**
```typescript
const uploadWithRetry = async (maxAttempts = 3) => {
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      const xhr = new XMLHttpRequest();
      xhr.timeout = 600000; // 10 –º–∏–Ω—É—Ç (–±—ã–ª–æ: default ~30s)
      
      xhr.addEventListener('timeout', () => {
        reject(new Error('Upload timeout'));
      });
      
      // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ XHR
      
    } catch (error) {
      if (attempt === maxAttempts) throw error;
      
      // Exponential backoff: 2s, 4s, 8s
      const delay = 2000 * Math.pow(2, attempt - 1);
      await new Promise(r => setTimeout(r, delay));
    }
  }
};

await uploadWithRetry(3);
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. ‚úÖ **–£–≤–µ–ª–∏—á–µ–Ω timeout** –¥–æ 10 –º–∏–Ω—É—Ç (–≤–º–µ—Å—Ç–æ ~30 —Å–µ–∫—É–Ω–¥)
2. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω retry** (3 –ø–æ–ø—ã—Ç–∫–∏)
3. ‚úÖ **Exponential backoff** –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ (2s ‚Üí 4s ‚Üí 8s)
4. ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ timeout —Å–æ–±—ã—Ç–∏–π**

---

## üéØ –ü–û–ß–ï–ú–£ –†–ê–ù–¨–®–ï –†–ê–ë–û–¢–ê–õ–û:

### –î–æ 18.11.2025:
- –ó–∞–≥—Ä—É–∂–∞–ª–∏ –∫–æ—Ä–æ—Ç–∫–∏–µ –≤–∏–¥–µ–æ (<20 –º–∏–Ω—É—Ç, <100 MB)
- –ë—Ä–∞—É–∑–µ—Ä —É—Å–ø–µ–≤–∞–ª –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π timeout
- 502 –æ—à–∏–±–∫–∏ –±—ã–ª–∏ —Ä–µ–¥–∫–∏–º–∏

### –ü–æ—Å–ª–µ 19-20.11.2025:
- –ù–∞—á–∞–ª–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–µ –≤–∏–¥–µ–æ (140 MB+)
- Browser XHR timeout –Ω–µ —Å–ø—Ä–∞–≤–ª—è–ª—Å—è
- –û—à–∏–±–∫–∏ —Å—Ç–∞–ª–∏ —á–∞—Å—Ç—ã–º–∏ –∏ –≤–∏–¥–∏–º—ã–º–∏

---

## üìä –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê:

### ‚úÖ Server-side —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ:
```bash
$ node test-large-file-upload.js
‚úÖ Method 1 (Buffer): 100 MB uploaded in 10.2s
‚úÖ Method 2 (Stream): 100 MB uploaded in 8.9s
```

### ‚ùå Browser XHR –ø–∞–¥–∞–ª:
```
üì§ Uploading file directly to storage...
Origin http://localhost:3000 is not allowed... Status code: 502
```

---

## ‚úÖ –¢–ï–ü–ï–†–¨ –î–û–õ–ñ–ù–û –†–ê–ë–û–¢–ê–¢–¨!

### –ß—Ç–æ —É–ª—É—á—à–µ–Ω–æ:

**Browser uploads:**
- ‚úÖ Timeout —É–≤–µ–ª–∏—á–µ–Ω –¥–æ 10 –º–∏–Ω—É—Ç
- ‚úÖ 3 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö retry
- ‚úÖ Exponential backoff

**Server uploads:**
- ‚úÖ Stream –≤–º–µ—Å—Ç–æ buffer
- ‚úÖ 5 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö retry  
- ‚úÖ Exponential backoff

---

## üß™ –ö–ê–ö –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–¢–¨:

### 1. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É:
```
Cmd + Shift + R (hard refresh)
```

### 2. –ü–æ–ø—Ä–æ–±—É–π –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ (138 MB):
```
–°–õ–ï–ü–ê–Ø_–¶–µ–Ω–∞ —Å—á–∞—Å—Ç—å—è_–û—Ç—Ä–∞–∂–µ–Ω–∏–µ —Å—É–¥—å–±—ã.mp4
138.74 MB
```

### 3. –°–ª–µ–¥–∏ –∑–∞ console:
```
üì§ Uploading file directly to storage...
Upload attempt 1/3...
‚è≥ Progress: 50%...
‚úÖ File uploaded to storage
```

–ï—Å–ª–∏ –ø–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ —É–ø–∞–¥—ë—Ç —Å 502:
```
‚ùå Attempt 1/3 failed
‚è≥ Waiting 2000ms before retry...
Upload attempt 2/3...
```

---

## üìù –ò–¢–û–ì–û–í–ê–Ø –°–í–û–î–ö–ê:

### –ß–¢–û –ë–´–õ–û:
- XHR timeout ~30 —Å–µ–∫—É–Ω–¥ (—Å–ª–∏—à–∫–æ–º –º–∞–ª–æ –¥–ª—è 140 MB)
- –ù–µ—Ç retry –ª–æ–≥–∏–∫–∏
- –ü—Ä–∏ 502 - —Å—Ä–∞–∑—É –æ—à–∏–±–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### –ß–¢–û –°–¢–ê–õ–û:
- XHR timeout 10 –º–∏–Ω—É—Ç (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤)
- 3 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö retry —Å backoff
- –ü—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö 502 - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç

---

## üéâ READY TO TEST!

**–ü–æ–ø—Ä–æ–±—É–π –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ –°–ï–ô–ß–ê–°!** üöÄ

–î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–º–Ω–æ–≥–æ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ!

---

–î–∞–π –∑–Ω–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç! üìä



