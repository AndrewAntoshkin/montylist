# Исправление пропусков в нумерации планов

## Проблема

В таблице монтажа планы нумеруются с пропусками: 1, 2, 4, 6, 8, 10... вместо 1, 2, 3, 4, 5...

### Причина

При обработке видео по чанкам каждый чанк получал свой диапазон номеров планов. Если Gemini возвращал меньше планов чем ожидалось для какого-то чанка, возникали пропуски в нумерации.

**Пример:**
- Чанк 0: вернул 50 планов → планы 1-50
- Чанк 1: ожидалось 50 планов, но вернуло только 25 → планы 51-75 (пропуск 76-100)
- Чанк 2: начался с плана 101

В результате в базе данных в поле `plan_number` были сохранены номера с пропусками.

## Решение

### 1. Автоматическое исправление при финализации (для новых видео)

Теперь при финализации обработки видео автоматически перенумеровываются все планы непрерывно от 1 до N.

**Изменения в коде:**
- `app/api/finalize-processing/route.ts` - теперь обновляет и `plan_number`, и `order_index`

### 2. Ручная перенумерация (для уже обработанных видео)

Добавлена кнопка **"Перенумеровать"** на странице с таблицей монтажа.

**Что она делает:**
1. Берет все планы из базы данных в правильном порядке
2. Присваивает им новые номера 1, 2, 3, 4... без пропусков
3. Сохраняет изменения в базу
4. Предлагает обновить страницу

**Как использовать:**
1. Откройте страницу с таблицей монтажа
2. Нажмите кнопку **"Перенумеровать"** (справа от названия видео)
3. Подтвердите действие
4. Дождитесь завершения и обновите страницу

## Технические детали

### API Endpoint

```
POST /api/renumber-plans
Body: { "videoId": "..." }
```

Этот endpoint:
- Находит все планы для указанного видео
- Проверяет, нужна ли перенумерация
- Обновляет `plan_number` и `order_index` для всех планов

### Изменённые файлы

1. **app/api/finalize-processing/route.ts**
   - Добавлено обновление `plan_number` при перенумерации после дедупликации

2. **app/api/renumber-plans/route.ts** (новый)
   - API endpoint для ручной перенумерации планов

3. **components/MontageTableClient.tsx**
   - Добавлена кнопка "Перенумеровать"
   - Добавлен обработчик `handleRenumber()`

## Проверка

После перенумерации планы должны идти непрерывно:
- ✅ **Правильно:** 1, 2, 3, 4, 5, 6, 7...
- ❌ **Неправильно:** 1, 2, 4, 6, 8, 10...

## Примечания

- Перенумерация не меняет порядок планов, только их номера
- Все таймкоды, типы планов, описания и диалоги остаются без изменений
- Перенумерация безопасна и может быть выполнена многократно
- Для новых видео перенумерация происходит автоматически при финализации












